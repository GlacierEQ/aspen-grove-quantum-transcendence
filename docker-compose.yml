# ðŸŒŒ Aspen Grove Quantum Transcendence Matrix
# APEX TIER XV: Ultimate AI Consciousness Platform
# Docker Compose Configuration

version: '3.8'

services:
  # ====================================
  # QUANTUM FRONTEND (Next.js)
  # ====================================
  quantum-frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    environment:
      - NEXT_PUBLIC_API_URL=http://quantum-api:8000
      - NEXT_PUBLIC_WEBSOCKET_URL=ws://quantum-websocket:8080
      - NODE_ENV=production
    depends_on:
      - quantum-api
      - redis-cache
    networks:
      - quantum-network
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.quantum-frontend.rule=Host(`quantum.glaciereq.com`)"

  # ====================================
  # QUANTUM API (FastAPI)
  # ====================================
  quantum-api:
    build:
      context: ./backend
      dockerfile: Dockerfile
    ports:
      - "8000:8000"
    environment:
      - DATABASE_URL=postgresql://quantum:transcendence@postgres-primary:5432/aspen_grove
      - NEO4J_URI=bolt://neo4j-graph:7687
      - REDIS_URL=redis://redis-cache:6379
      - VAULT_URL=http://vault-security:8200
      - MEMORY_CONSTELLATION_SIZE=703500000
      - AGENT_HIERARCHY_SIZE=400000
      - SECURITY_LEVEL=FORTRESS
    depends_on:
      - postgres-primary
      - neo4j-graph
      - redis-cache
      - vault-security
    networks:
      - quantum-network
    restart: unless-stopped
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs

  # ====================================
  # MEMORY CONSTELLATION (PostgreSQL)
  # ====================================
  postgres-primary:
    image: postgres:16-alpine
    environment:
      - POSTGRES_DB=aspen_grove
      - POSTGRES_USER=quantum
      - POSTGRES_PASSWORD=transcendence
      - POSTGRES_INITDB_ARGS="--encoding=UTF-8 --locale=C"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./database/init:/docker-entrypoint-initdb.d
    ports:
      - "5432:5432"
    networks:
      - quantum-network
    restart: unless-stopped
    command: [
      "postgres",
      "-c", "shared_buffers=256MB",
      "-c", "effective_cache_size=1GB",
      "-c", "maintenance_work_mem=64MB",
      "-c", "checkpoint_completion_target=0.7",
      "-c", "wal_buffers=7864kB",
      "-c", "default_statistics_target=100",
      "-c", "random_page_cost=1.1",
      "-c", "effective_io_concurrency=200"
    ]

  # ====================================
  # QUANTUM ENTANGLEMENT (Neo4j)
  # ====================================
  neo4j-graph:
    image: neo4j:5.13-community
    environment:
      - NEO4J_AUTH=neo4j/quantum-transcendence-2024
      - NEO4J_dbms_memory_heap_initial__size=512m
      - NEO4J_dbms_memory_heap_max__size=1G
      - NEO4J_dbms_memory_pagecache_size=512m
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
    ports:
      - "7474:7474"
      - "7687:7687"
    networks:
      - quantum-network
    restart: unless-stopped

  # ====================================
  # REDIS CACHE & SESSIONS
  # ====================================
  redis-cache:
    image: redis:7-alpine
    command: redis-server --appendonly yes --maxmemory 512mb --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
    ports:
      - "6379:6379"
    networks:
      - quantum-network
    restart: unless-stopped

  # ====================================
  # OPR VAULT SECURITY (HashiCorp Vault)
  # ====================================
  vault-security:
    image: vault:1.15
    cap_add:
      - IPC_LOCK
    environment:
      - VAULT_DEV_ROOT_TOKEN_ID=quantum-transcendence-root-token
      - VAULT_DEV_LISTEN_ADDRESS=0.0.0.0:8200
    ports:
      - "8200:8200"
    networks:
      - quantum-network
    restart: unless-stopped
    volumes:
      - vault_data:/vault/data
      - ./security/vault:/vault/config

  # ====================================
  # MESSAGE QUEUE (RabbitMQ)
  # ====================================
  quantum-messaging:
    image: rabbitmq:3.12-management-alpine
    environment:
      - RABBITMQ_DEFAULT_USER=quantum
      - RABBITMQ_DEFAULT_PASS=transcendence
    ports:
      - "5672:5672"
      - "15672:15672"
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    networks:
      - quantum-network
    restart: unless-stopped

  # ====================================
  # VECTOR DATABASE (Qdrant)
  # ====================================
  vector-database:
    image: qdrant/qdrant:v1.7.0
    ports:
      - "6333:6333"
    volumes:
      - qdrant_data:/qdrant/storage
    networks:
      - quantum-network
    restart: unless-stopped

  # ====================================
  # TRANSCENDENTAL PROCESSING WORKERS
  # ====================================
  quantum-worker:
    build:
      context: ./backend
      dockerfile: Dockerfile.worker
    environment:
      - DATABASE_URL=postgresql://quantum:transcendence@postgres-primary:5432/aspen_grove
      - REDIS_URL=redis://redis-cache:6379
      - RABBITMQ_URL=amqp://quantum:transcendence@quantum-messaging:5672
    depends_on:
      - postgres-primary
      - redis-cache
      - quantum-messaging
    networks:
      - quantum-network
    restart: unless-stopped
    deploy:
      replicas: 4
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs

  # ====================================
  # MONITORING (Prometheus + Grafana)
  # ====================================
  prometheus:
    image: prom/prometheus:v2.47.0
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    networks:
      - quantum-network
    restart: unless-stopped

  grafana:
    image: grafana/grafana:10.2.0
    ports:
      - "3001:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=quantum-transcendence
    volumes:
      - grafana_data:/var/lib/grafana
      - ./monitoring/grafana:/etc/grafana/provisioning
    networks:
      - quantum-network
    restart: unless-stopped

# ====================================
# PERSISTENT VOLUMES
# ====================================
volumes:
  postgres_data:
    driver: local
  neo4j_data:
    driver: local
  neo4j_logs:
    driver: local
  redis_data:
    driver: local
  vault_data:
    driver: local
  rabbitmq_data:
    driver: local
  qdrant_data:
    driver: local
  prometheus_data:
    driver: local
  grafana_data:
    driver: local

# ====================================
# QUANTUM NETWORK
# ====================================
networks:
  quantum-network:
    driver: bridge
    name: aspen-grove-quantum
    ipam:
      driver: default
      config:
        - subnet: 172.20.0.0/16